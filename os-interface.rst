==================================
Intel® On Demand In-band Interface
==================================

On Demand Capability Enumeration
--------------------------------

Intel On Demand is enumerated, per socket, as a PCI Express Vendor Specific
Capability (VSEC) on a PCIe endpoint device. The table below shows the entire
VSEC header for On Demand including the PCI Express Extended capability header.
The VSEC is used by software to locate the On Demand discovery structure.

Refer to the PCI Express Specification for details on the Vendor Specific
Capability definitions.

+---------------+---------------+---------------+---------------+
|    Byte 3     |    Byte 2     |    Byte 1     |    Byte 0     |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next                  | Cap   |  PCI Express Extended         |
| Capability            | Ver = |  Capability ID = 000Bh        |
| Offset                | 1h    |                               |
+-----------------------+-------+-------------------------------+
|                       | VSEC  |                               |
| VSEC Length = 10h     | REV = |  VSEC ID = 0041h              |
|                       | 1h    |  (On Demand Capability No.)   |
+---------------+-------+-------+-------------------------------+
| Entry Size    | Number of     |                               |
| = 4 (MMIO size| Entries = 1   |  Reserved                     |
| in DWORDS)    |               |                               |
+---------------+---------------+-------------------------+-----+
|                                                         |     |
| Offset                                                  | TBIR|
+---------------------------------------------------------+-----+

On Demand discovery structure
-----------------------------

The On Demand discovery structure provides the location of the memory mapped
region used to access the On Demand mailbox and hardware registers.

+---------------+---------------+---------------+---------------+
|    Byte 3     |    Byte 2     |    Byte 1     |    Byte 0     |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| RSVD  |       Size in DWORDS          |   Type = 3    | Access|
|       |                               |               | Type  |
+-------+-------------------------------+---------------+-------+
|                            GUID                               |
+---------------------------------------------------------+-----+
|                                                         |     |
| BAR Offset from TBIR                                    | TBIR|
+---------------------------------------------------------+-----+

Access Type = 2: MMIO space is at BAR[TBIR] + Offset

Access Type = 3: MMIO space is at OFFSET + 10h from the from the address of the On Demand discover structure

GUID: An ID that identifies the memory layout of the registers in the On Demand MMIO space.


On Demand MMIO layout for GUID = 006DD191h
------------------------------------------

+--------------------+-----+---------+----------+---------------------------------------+
| Name               | R/W | Size    | Offset   | Description                           |
|                    |     | (Bytes) | (DWORDS) |                                       |
+====================+=====+=========+==========+=======================================+
| Control Structure  | R/W | 8       |  0       | Control for mailbox (see below)       |
+--------------------+-----+---------+----------+---------------------------------------+
| Mailbox            | R/W | 1024    |  2       | Mailbox buffer (see below)            |
+--------------------+-----+---------+----------+---------------------------------------+
| PPIN               | R   | 8       |  258     | Protected Processor Inventory Number  |
+--------------------+-----+---------+----------+---------------------------------------+
| Registers          | R   | 48      |  260     | On Demand registers (see below)       |
+--------------------+-----+---------+----------+---------------------------------------+
| PCU_CR3_CAPID1_CFG | R   | 8       |  272     |                                       |
+--------------------+-----+---------+----------+---------------------------------------+
| Socket ID          | R   | 8       |  274     | Socket ID is bits 3:0                 |
+--------------------+-----+---------+----------+---------------------------------------+


On Demand MMIO layout for GUID = F210D9EFh
------------------------------------------

+--------------------+-----+---------+----------+---------------------------------------+
| Name               | R/W | Size    | Offset   | Description                           |
|                    |     | (Bytes) | (DWORDS) |                                       |
+====================+=====+=========+==========+=======================================+
| Control Structure  | R/W | 16      |  0       | Control for mailbox (see below)       |
+--------------------+-----+---------+----------+---------------------------------------+
| Mailbox            | R/W | 1024    |  4       | Mailbox buffer (see below)            |
+--------------------+-----+---------+----------+---------------------------------------+
| PPIN               | R   | 8       |  260     | Protected Processor Inventory Number  |
+--------------------+-----+---------+----------+---------------------------------------+
| Registers          | R   | 48      |  262     | On Demand registers (see below)       |
+--------------------+-----+---------+----------+---------------------------------------+
| PCU_CR3_CAPID1_CFG | R   | 4       |  274     |                                       |
+--------------------+-----+---------+----------+---------------------------------------+
| RESERVED           | R   | 4       |  275     |                                       |
+--------------------+-----+---------+----------+---------------------------------------+
| Socket ID          | R   | 4       |  276     | Socket ID is bits 3:0                 |
+--------------------+-----+---------+----------+---------------------------------------+


On Demand MMIO details
----------------------

Control Structure for GUID = 006DD191h
++++++++++++++++++++++++++++++++++++++

+---------------+---------------+---------------+-------------------------------+
|    Byte 3     |    Byte 2     |    Byte 1     |             Byte 0            |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+===+===+===+===+===+===+===+===+
|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+---+---+---+---+---+---+---+---+
| Packet Size                   | Status        |RDY|CPL| Owner |EOM|SOM|R/W|RUN|
|                               | Code          |   |   |       |   |   |   |BSY|
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
+-------------------------------+---------------+---+---+-------+---+---+---+---+
| Message Size                  | Reserved                                      |
+-------------------------------+-----------------------------------------------+

Control Structure for GUID = F210D9EFh
++++++++++++++++++++++++++++++++++++++

+---------------+---------------+---------------+-------------------------------+
|    Byte 3     |    Byte 2     |    Byte 1     |             Byte 0            |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+===+===+===+===+===+===+===+===+
|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+---+---+---+---+---+---+---+---+
| Packet Size                   | Status        |RDY|CPL| Owner |EOM|SOM|R/W|RUN|
|                               | Code          |   |   |       |   |   |   |BSY|
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
|                               |               |   |   |       |   |   |   |   |
+-------------------------------+---------------+---+---+-------+---+---+---+---+
| Message Size                  | Reserved                                  | I |
|                               |                                           | B |
|                               |                                           | L |
|                               |                                           | O |
|                               |                                           | C |
|                               |                                           | K |
+-------------------------------+-------------------------------------------+---+
| Reserved                      | Metering update period                        |
+-------------------------------+-----------------------------------------------+
| Reserved                                                                      |
+-------------------------------+-----------------------------------------------+

CONTROL FIELDS

+--------+----------+---------------+-----+---------------------------------------------------------+
| Bits   | Field    | Default value | R/W |                    Description                          |
+========+==========+===============+=====+=========================================================+
| 0      | RUN/BUSY | 0             | R/W | Flag is set by requester to initiate data transmission. |
|        |          |               |     | On Demand firmware clears this flag when the            |
|        |          |               |     | transmission has ended.                                 |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 1      | Read/    | 0             | R/W | Determines whether read from or write to mailbox shall  |
|        | Write    |               |     | be performed:                                           |
|        | Command  |               |     |                                                         |
|        |          |               |     | = 0 for read                                            |
|        |          |               |     |                                                         |
|        |          |               |     | = 1 for write                                           |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 2      | SOM      | 0             | R/W | When data is ready to be read, this bit is set by       |
|        |          |               |     | firmware to indicate that the data in the mailbox is    |
|        |          |               |     | the first packet.                                       |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 3      | EOM      | 0             | R/W | When data is ready to be read, this bit is set by       |
|        |          |               |     | firmware to indicate that the data in the mailbox is    |
|        |          |               |     | the last packet.                                        |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 5:4    | Owner    | 0             | R   | Mailbox ownership – read only:                          |
|        |          |               |     |                                                         |
|        |          |               |     | 2’b00 – None – Mailbox is free to use                   |
|        |          |               |     |                                                         |
|        |          |               |     | 2’b01 – In-band agent                                   |
|        |          |               |     |                                                         |
|        |          |               |     | 2’b10 – Out-of-band agent                               |
|        |          |               |     |                                                         |
|        |          |               |     | 2’b11 – Reserved                                        |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 6      | CPL      | 0             | R/W | Complete bit.                                           |
|        |          |               |     |                                                         |
|        |          |               |     | At the end of data transmission, used to indicate to    |
|        |          |               |     | firmware that processing is complete and ownership of   |
|        |          |               |     | the mailbox is relinquished.                            |
|        |          |               |     |                                                         |
|        |          |               |     | Read command: For reads greater than 1024B, setting     |
|        |          |               |     | this bit also adjusts the buffer read position forward  |
|        |          |               |     | by 1024B.                                               |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 7      | RDY      | 0             | R   | Read command only. This bit is set by firmware when a   |
|        |          |               |     | packet is ready to be read.                             |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 15:8   | Status   | 0             | R   | Status of mailbox operation filled by firmware at the   |
|        | Code     |               |     | end of a read or write operation.                       |
|        |          |               |     |                                                         |
|        |          |               |     | = 0x40 – Success                                        |
|        |          |               |     |                                                         |
|        |          |               |     | = 0x80 – Timeout                                        |
|        |          |               |     |                                                         |
|        |          |               |     | = 0x90 – Failure                                        |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 31:16  | Packet   | 0             | R/W | Mailbox packet size in bytes. Written by the requester  |
|        | Size     |               |     | at start of transmission. Written by the firmware when  |
|        |          |               |     | data is ready to be read.                               |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 32     | In-Band  | 0             |     | If set, indicates in-band access is locked by BIOS.     |
|        | Lock     |               |     |                                                         |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 47:33  | Reserved |               |     |                                                         |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 63:48  | Message  | 0             | R   | Read command only. Total message size in bytes. Set by  |
|        | Size     |               |     | firmware when data is greater than 1024B. Size is QWORD |
|        |          |               |     | aligned.                                                |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 79:64  | Metering |               |     |                                                         |
|        | Update   |               |     |                                                         |
|        | Period   |               |     |                                                         |
+--------+----------+---------------+-----+---------------------------------------------------------+
| 127:80 | Reserved |               |     |                                                         |
+--------+----------+---------------+-----+---------------------------------------------------------+

Mailbox
+++++++

+---------------+---------------+---------------+---------------+-------+
|    Byte 3     |    Byte 2     |    Byte 1     |    Byte 0     | DWORD |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=======+
|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|7|6|5|4|3|2|1|0|       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------+
|                       (63:0) Data 0                           |   0   |
|                                                               +-------+
|                                                               |   1   |
+---------------------------------------------------------------+-------+
|                          ...                                          |
+---------------------------------------------------------------+-------+
|                  (8191:8128) Data 127                         |  254  |
|                                                               +-------+
|                                                               |  255  |
+---------------------------------------------------------------+-------+

MAILBOX COMMANDS

+------------------+------------+---------------------------------------------------------+
| Command Name     | Command ID | Description                                             |
+==================+============+=========================================================+
| PROVISION_AKC    | 0x04       | Write the authentication key certificate (AKC) in the   |
|                  |            | mailbox to On Demand hardware.                          |
+------------------+------------+---------------------------------------------------------+
| PROVISION_CAP    | 0x08       | Write the capability activation payload (CAP) in the    |
|                  |            | mailbox to On Demand hardware.                          |
+------------------+------------+---------------------------------------------------------+
| READ_STATE_CERT  | 0x10       | Read the state certificate from the On Demand hardware  |
|                  |            | to mailbox.                                             |
+------------------+------------+---------------------------------------------------------+
| READ_METER_CERT  | 0x14       | Read the meter certificate from the On Demand hardware  |
|                  |            | to mailbox.                                             |
+------------------+------------+---------------------------------------------------------+

Mailbox commands are written to the Mailbox buffer in the last QWORD following a
payload, if applicable.

On Demand Registers
+++++++++++++++++++

+--------+---------+---------------------------------+---------------------------------+
| Offset | Size    | Name                            | Description                     |
|        | (bytes) |                                 |                                 |
+========+=========+=================================+=================================+
|  0x00  |  8      | CONTENT_AUTH_ERROR_STATUS       | Content authorization error     |
|        |         |                                 | status                          |
+--------+---------+---------------------------------+---------------------------------+
|  0x08  |  8      | ENABLED_FEATURES                | Enabled features (see below)    |
+--------+---------+---------------------------------+---------------------------------+
|  0x10  |  8      | KEY_PROVISIONING_STATUS         | Key provisioning status         |
+--------+---------+---------------------------------+---------------------------------+
|  0x18  |  8      | PROVISIONING_AUTH_FAILURE_COUNT | Failure counts (see below)      |
+--------+---------+---------------------------------+---------------------------------+
|  0x20  |  8      | PROVISIONING_AVAILABILITY       | Provisioning availability (see  |
|        |         |                                 | below)                          |
+--------+---------+---------------------------------+---------------------------------+
|  0x28  |  8      | NVRAM_UPDATE_LIMITS             | NVRAM update limits             |
+--------+---------+---------------------------------+---------------------------------+

CONTENT_AUTH_ERROR_STATUS

+--------+-------+------------------------------------+--------------------------------+
| Bit    | Bit   | Name                               | Description                    |
| Offset | Width |                                    |                                |
+========+=======+====================================+================================+
|  63:6  |  58   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  5     |  1    | METERING_AUTH_ERROR                | Metering authentication failed |
+--------+-------+------------------------------------+--------------------------------+
|  4     |  1    | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  3     |  1    | CONTENT_AUTH_ERROR                 | Provisioning authentication    |
|        |       |                                    | failed                         |
+--------+-------+------------------------------------+--------------------------------+
|  2:0   |  3    | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+

KEY_PROVISIONING_STATUS

+--------+-------+------------------------------------+--------------------------------+
| Bit    | Bit   | Name                               | Description                    |
| Offset | Width |                                    |                                |
+========+=======+====================================+================================+
|  63:2  |  62   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  1     |  1    | LICENSE_KEY_PROVISIONED            | License key is provisioned     |
+--------+-------+------------------------------------+--------------------------------+
|  0     |  1    | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+

ENABLED_FEATURES

+--------+-------+------------------------------------+--------------------------------+
| Bit    | Bit   | Name                               | Description                    |
| Offset | Width |                                    |                                |
+========+=======+====================================+================================+
|  63:27 |  37   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  26    |  1    | METERING                           | Metering is enabled            |
+--------+-------+------------------------------------+--------------------------------+
|  25:13 |  13   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  12    |  1    | ATTESTATION                        | Attestation is enabled         |
+--------+-------+------------------------------------+--------------------------------+
|  11:4  |  8    | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  3     |  1    | ON_DEMAND                          | Provisioning is enabled        |
+--------+-------+------------------------------------+--------------------------------+
|  2:0   |  3    | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+

PROVISIONING_AUTH_FAILURE_COUNT

+--------+-------+------------------------------------+--------------------------------+
| Bit    | Bit   | Name                               | Description                    |
| Offset | Width |                                    |                                |
+========+=======+====================================+================================+
|  63:12 |  52   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  11:9  |  3    | LICENSE_AUTH_FAILURE_THRESHOLD     | Capability activation payload  |
|        |       |                                    | provisioning failure threshold |
|        |       |                                    | between power cycles           |
+--------+-------+------------------------------------+--------------------------------+
|  8:6   |  3    | LICENSE_AUTH_FAILURE_COUNT         | Number of times capability     |
|        |       |                                    | activation payload provisioning|
|        |       |                                    | failed in a power cycle        |
+--------+-------+------------------------------------+--------------------------------+
|  5:3   |  3    | LICENSE_KEY_AUTH_FAILURE_THRESHOLD | Authentication key certificate |
|        |       |                                    | provisioning failure threshold |
|        |       |                                    | between power cycles           |
+--------+-------+------------------------------------+--------------------------------+
|  2:0   |  3    | LICENSE_KEY_AUTH_FAILURE_COUNT     | Number of times authentication |
|        |       |                                    | key certificate provisioning   |
|        |       |                                    | failed in a power cycle        |
+--------+-------+------------------------------------+--------------------------------+

PROVISIONING_AVAILABILITY

+--------+-------+------------------------------------+--------------------------------+
| Bit    | Bit   | Name                               | Description                    |
| Offset | Width |                                    |                                |
+========+=======+====================================+================================+
|  63:54 |  10   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  53:51 |  3    | UPDATES_THRESHOLD                  | Maximum number of provision    |
|        |       |                                    | operations allowed between     |
|        |       |                                    | power cycles                   |
+--------+-------+------------------------------------+--------------------------------+
|  50:48 |  3    | UPDATES_AVAILABLE                  | Number of provision operations |
|        |       |                                    | left before power cycle        |
|        |       |                                    | required                       |
+--------+-------+------------------------------------+--------------------------------+
|  47:0  |  48   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+

NVRAM_UPDATE_LIMITS

+--------+-------+------------------------------------+--------------------------------+
| Bit    | Bit   | Name                               | Description                    |
| Offset | Width |                                    |                                |
+========+=======+====================================+================================+
|  63:15 |  49   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
|  14    |  1    | NVRAM_90_PCT                       | NVRAM reached 90% update       |
|        |       |                                    | limits.                        |
+--------+-------+------------------------------------+--------------------------------+
|  13    |  1    | NVRAM_75_PCT                       | NVRAM reached 75% update       |
|        |       |                                    | limits.                        |
+--------+-------+------------------------------------+--------------------------------+
|  12    |  1    | NVRAM_50_PCT                       | NVRAM reached 50% update       |
|        |       |                                    | limits.                        |
+--------+-------+------------------------------------+--------------------------------+
|  11:0  |  12   | RESERVED                           |                                |
+--------+-------+------------------------------------+--------------------------------+
